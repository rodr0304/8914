<!DOCTYPE html>
<!-- LAB7 Q2/Q3: Accessible form markup + focus management + error summary + URL prefill + NO jQuery dependency -->
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Feedback form</title>

  <style>
    .control, fieldset { margin: 6px 0; }
    label { display: inline-block; width: 120px; vertical-align: top; }
    input + label { width: auto; }

    .error, .required { color: red; }
    fieldset ul { margin: 0; }

    /* LAB7 Q1/Q3: Visible focus indicator */
    :focus-visible { outline: 3px solid #000; outline-offset: 2px; }

    /* LAB7 Q3: Utility */
    .hidden { display: none; }

    /* LAB7 Q3: Error summary box */
    .error-summary {
      border: 2px solid #b00020;
      padding: 12px;
      margin: 12px 0;
    }
    .error-summary h2 { margin-top: 0; }

    .field-error { margin-left: 120px; } /* aligns with label width */

    /* LAB7: Offscreen helper for screen-reader-only text */
    .offscreen {
      position: absolute;
      left: -10000px;
      top: auto;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }
  </style>
</head>

<body>
  <h1>Feedback form</h1>

  <form action="" method="get" novalidate>
    <!-- LAB7 Q3: Accessible error summary (focus moves here when errors exist) -->
    <fieldset id="errorSummary"
              class="error-summary hidden"
              aria-labelledby="errorSummaryTitle"
              role="alert"
              aria-live="assertive"
              tabindex="-1">
      <legend id="errorSummaryTitle">Errors</legend>
      <ul id="errorList"></ul>
    </fieldset>

    <!-- LAB7 Q3: Success message shown only when the form is valid -->
    <div id="successMessage" class="hidden" role="status" aria-live="polite" tabindex="-1">
      All inputs are valid.
    </div>

    <div class="control">
      <!-- LAB7 Q2: Proper label association -->
      <label for="name">Full name <span class="required" aria-hidden="true">*</span></label>
      <input id="name" name="name" type="text" aria-required="true" />
      <span id="name_description" class="offscreen">Full name is required.</span>
    </div>

    <div class="control">
      <!-- LAB7 Q2: Proper label association -->
      <label for="biography">Biography</label>
      <textarea id="biography" name="biography"></textarea>
      <span id="biography_help">Include examples on your skills in JavaScript.</span>
    </div>

    <!-- LAB7 Q2: Use fieldset/legend for radio group -->
    <fieldset class="control">
      <legend>Gender <span class="required" aria-hidden="true">*</span></legend>
      <span id="gender_description" class="offscreen">Gender is required.</span>

      <div class="control">
        <input id="gender_male" name="gender" type="radio" value="male" />
        <label for="gender_male">Male</label>
      </div>

      <div class="control">
        <input id="gender_female" name="gender" type="radio" value="female" />
        <label for="gender_female">Female</label>
      </div>
    </fieldset>

    <div class="control">
      <input id="accept_agbs" name="accept_agbs" type="checkbox" value="1" />
      <label for="accept_agbs">I accept the terms and conditions</label>
      <span id="accept_agbs_description" class="offscreen">You must accept the terms and conditions.</span>
    </div>

    <div class="control">
      <!-- Keep hidden validate for submission compatibility -->
      <input name="validate" type="hidden" value="1" />
      <input type="submit" value="Register" />
    </div>
  </form>

  <script>
    "use strict";

    // ---------- Helpers ----------
    function $(id) { return document.getElementById(id); }

    function show(el) { el.classList.remove("hidden"); }
    function hide(el) { el.classList.add("hidden"); }

    function clearChildren(el) {
      while (el.firstChild) el.removeChild(el.firstChild);
    }

    function removeInlineErrors() {
      document.querySelectorAll(".field-error").forEach(el => el.remove());
      document.querySelectorAll('[aria-invalid="true"]').forEach(el => el.removeAttribute("aria-invalid"));
      document.querySelectorAll('[data-error-describedby="true"]').forEach(el => {
        el.removeAttribute("aria-describedby");
        el.removeAttribute("data-error-describedby");
      });
    }

    // LAB7 Q3: inline error and aria-describedby connection
    function setInlineError(fieldEl, message, errorId, appendToFieldset) {
      fieldEl.setAttribute("aria-invalid", "true");
      fieldEl.setAttribute("aria-describedby", errorId);
      fieldEl.setAttribute("data-error-describedby", "true");

      const err = document.createElement("div");
      err.className = "field-error error";
      err.id = errorId;
      err.setAttribute("aria-live", "polite");
      err.textContent = message;

      if (appendToFieldset) {
        appendToFieldset.appendChild(err);
      } else {
        fieldEl.insertAdjacentElement("afterend", err);
      }
    }

    // LAB7 Q3: error summary items that focus correct field
    function addErrorSummaryItem(listEl, fieldEl, fieldId, message) {
      const li = document.createElement("li");
      const a = document.createElement("a");

      // LAB7 Q3 (R.G. hint fixed): link must have a valid href target
      a.href = "#" + fieldId;
      a.textContent = message;

      a.addEventListener("click", function (e) {
        e.preventDefault();
        fieldEl.focus();
        history.replaceState(null, "", "#" + fieldId);
      });

      li.appendChild(a);
      listEl.appendChild(li);
    }

    // ---------- Validation ----------
    function validateForm() {
      const errors = [];

      const nameEl = $("name");
      const bioEl = $("biography");
      const termsEl = $("accept_agbs");
      const genderMaleEl = $("gender_male");
      const genderFemaleEl = $("gender_female");
      const genderFieldset = genderMaleEl.closest("fieldset");

      const errorSummary = $("errorSummary");
      const errorList = $("errorList");
      const successMessage = $("successMessage");

      // Reset UI
      removeInlineErrors();
      clearChildren(errorList);
      hide(errorSummary);
      hide(successMessage);

      // Name required
      if (!nameEl.value || !nameEl.value.trim()) {
        const msg = "Please enter your name!";
        errors.push({ msg, fieldEl: nameEl, fieldId: "name" });
        setInlineError(nameEl, msg, "name_error", null);
      }

      // Biography required (as in starter behavior)
      if (!bioEl.value || !bioEl.value.trim()) {
        const msg = "Please tell us something about your history!";
        errors.push({ msg, fieldEl: bioEl, fieldId: "biography" });
        setInlineError(bioEl, msg, "biography_error", null);
      } else {
        // Keep help text association when valid
        bioEl.setAttribute("aria-describedby", "biography_help");
      }

      // Gender required
      const genderChecked = document.querySelector('input[name="gender"]:checked');
      if (!genderChecked) {
        const msg = "Please tell us your gender!";
        // Focus first radio if missing
        errors.push({ msg, fieldEl: genderMaleEl, fieldId: "gender_male" });
        setInlineError(genderMaleEl, msg, "gender_error", genderFieldset);
      }

      // Terms required
      if (!termsEl.checked) {
        const msg = "You must accept our terms and conditions!";
        errors.push({ msg, fieldEl: termsEl, fieldId: "accept_agbs" });
        setInlineError(termsEl, msg, "accept_agbs_error", null);
      }

      // If errors: show summary, focus it
      if (errors.length > 0) {
        errors.forEach(err => addErrorSummaryItem(errorList, err.fieldEl, err.fieldId, err.msg));
        show(errorSummary);
        errorSummary.focus();
        return false;
      }

      // If valid: show success message and focus it
      show(successMessage);
      successMessage.focus();
      return true;
    }

    // ---------- URL Prefill + Auto Validate ----------
    document.addEventListener("DOMContentLoaded", function () {
      const params = new URLSearchParams(window.location.search);

      // LAB7 Q3: Pre-fill from URL params (works reliably on GitHub Pages)
      if (params.get("name")) $("name").value = params.get("name");
      if (params.get("biography")) $("biography").value = params.get("biography");

      if (params.get("gender")) {
        const g = params.get("gender");
        const radio = document.querySelector('input[name="gender"][value="' + g + '"]');
        if (radio) radio.checked = true;
      }

      if (params.get("accept_agbs") === "1") $("accept_agbs").checked = true;

      // Auto validate only when validate=1 is present in the URL
      if (params.get("validate")) validateForm();

      // Always validate on submit (keyboard-friendly, no page reload)
      document.querySelector("form").addEventListener("submit", function (e) {
        e.preventDefault();
        validateForm();
      });
    });
  </script>
</body>
</html>
