<!DOCTYPE html>
<!-- LAB7 Q2/Q3: Accessible form markup + focus management + error summary + no alert() -->
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Feedback form</title>
  <style>
    .control, fieldset { margin: 6px 0; }

    label { display: inline-block; width: 120px; vertical-align: top; }
    input + label { width: auto; }

    .error, .required { color: red; }

    fieldset ul { margin: 0; }

    /* LAB7 Q1/Q3: Visible focus indicator */
    :focus-visible { outline: 3px solid #000; outline-offset: 2px; }

    /* LAB7 Q3: utility */
    .hidden { display: none; }

    /* LAB7 Q3: error summary box */
    .error-summary {
      border: 2px solid #b00020;
      padding: 12px;
      margin: 12px 0;
    }
    .error-summary h2 { margin-top: 0; }

    .field-error { margin-left: 120px; } /* aligns with label width */
  </style>
</head>

<body>
  <h1>Feedback form</h1>

  <form action="" method="get" novalidate>
    <!-- LAB7 Q3: Added accessible error summary (focus will move here when errors exist) -->
    <fieldset id="errorSummary" class="error-summary hidden" aria-labelledby="errorSummaryTitle" role="alert" aria-live="assertive" tabindex="-1">
      <legend id="errorSummaryTitle">Errors</legend>
      <ul id="errorList"></ul>
    </fieldset>

    <!-- LAB7 Q3: Added success message shown only when all inputs are valid -->
    <div id="successMessage" class="hidden" role="status" aria-live="polite" tabindex="-1">
      All inputs are valid.
    </div>

    <div class="control">
      <!-- LAB7 Q2: Added for/id association for label/input -->
      <label for="name">Full name <span class="required" aria-hidden="true">*</span></label>
      <input id="name" name="name" type="text" aria-required="true" aria-describedby="name_description" />
      <!-- LAB7 Q3: Description element exists for aria-describedby -->
      <span id="name_description" class="offscreen">Full name is required.</span>
    </div>

    <div class="control">
      <!-- LAB7 Q2: Added for/id association -->
      <label for="biography">Biography</label>
      <textarea id="biography" name="biography"></textarea>
      <!-- LAB7 Q2/Q3: Gave help text an id to support aria-describedby when needed -->
      <span id="biography_help">Include examples on your skills in JavaScript.</span>
    </div>

    <!-- LAB7 Q2: Use fieldset/legend for radio group -->
    <fieldset class="control" aria-describedby="gender_description">
      <legend>Gender <span class="required" aria-hidden="true">*</span></legend>
      <span id="gender_description" class="offscreen">Gender is required.</span>

      <div class="control">
        <input id="gender_male" name="gender" type="radio" value="male" />
        <label for="gender_male">Male</label>
      </div>

      <div class="control">
        <input id="gender_female" name="gender" type="radio" value="female" />
        <label for="gender_female">Female</label>
      </div>
    </fieldset>

    <div class="control">
      <input id="accept_agbs" name="accept_agbs" type="checkbox" value="1" aria-describedby="accept_agbs_description" />
      <label for="accept_agbs">I accept the terms and conditions</label>
      <span id="accept_agbs_description" class="offscreen">You must accept the terms and conditions.</span>
    </div>

    <div class="control">
      <input name="validate" type="hidden" value="1" />
      <input type="submit" value="Register" />
    </div>
  </form>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>

  <script>
    "use strict";

    (function () {
      // LAB7 Q3: helper to read URL param (kept from starter code)
      $.urlParam = function (name) {
        var results = new RegExp('[?&]' + name + '=([^&#]*)').exec(window.location.href);
        return results === null ? null : (decodeURI(results[1]) || null);
      };

      // LAB7 Q3: Clear previous inline errors
      function clearInlineErrors() {
        $('.field-error').remove();
        $('[aria-invalid="true"]').removeAttr('aria-invalid');
        $('[data-has-error="true"]').removeAttr('data-has-error');
        // Keep help text ids intact; remove only error-specific describedby when we add it
        $('[data-error-describedby="true"]').each(function () {
          $(this).removeAttr('aria-describedby');
          $(this).removeAttr('data-error-describedby');
        });
      }

      // LAB7 Q3: Show inline field error and connect via aria-describedby
      function showInlineError($el, message, describedById) {
        $el.attr('aria-invalid', 'true');
        $el.attr('data-has-error', 'true');

        // Attach aria-describedby to the error text we create (for SR)
        $el.attr('aria-describedby', describedById);
        $el.attr('data-error-describedby', 'true');

        var $err = $('<div class="field-error error" id="' + describedById + '" aria-live="polite"></div>');
        $err.text(message);

        // Place error after the field (or after fieldset for radios)
        if ($el.is(':radio')) {
          $el.closest('fieldset').append($err);
        } else {
          $el.after($err);
        }
      }

      // LAB7 Q3: Build error summary with links that move focus
      function addErrorSummaryItem($list, $focusEl, focusId, message) {
        // R.G. hint fixed: anchor now has href that points to a real id
        var $a = $('<a></a>');
        $a.attr('href', '#' + focusId);
        $a.text(message);
        $a.on('click', function (e) {
          e.preventDefault();
          $focusEl.focus();
          history.replaceState(null, '', '#' + focusId);
        });

        $list.append($('<li></li>').append($a));
      }

      function validateForm() {
        var errors = [];

        var $name = $('#name');
        var $bio = $('#biography');
        var $gender = $('input[name="gender"]');
        var $terms = $('#accept_agbs');

        // Clear UI
        clearInlineErrors();
        $('#errorList').empty();
        $('#errorSummary').addClass('hidden');
        $('#successMessage').addClass('hidden');

        // Validate name
        if (!$name.val() || !$name.val().trim()) {
          errors.push({
            message: 'Please enter your name!',
            $focus: $name,
            focusId: 'name',
            inlineId: 'name_error'
          });
          showInlineError($name, 'Please enter your name!', 'name_error');
        }

        // Validate biography
        if (!$bio.val() || !$bio.val().trim()) {
          errors.push({
            message: 'Please tell us something about your history!',
            $focus: $bio,
            focusId: 'biography',
            inlineId: 'biography_error'
          });
          showInlineError($bio, 'Please tell us something about your history!', 'biography_error');
        } else {
          // LAB7 Q2: Keep existing help association when valid
          $bio.attr('aria-describedby', 'biography_help');
        }

        // Validate gender (radio group)
        if ($gender.filter(':checked').length === 0) {
          var $focusRadio = $('#gender_male'); // focus first option
          errors.push({
            message: 'Please tell us your gender!',
            $focus: $focusRadio,
            focusId: 'gender_male',
            inlineId: 'gender_error'
          });
          // Mark first radio invalid and attach message at end of fieldset
          showInlineError($focusRadio, 'Please tell us your gender!', 'gender_error');
        }

        // Validate terms
        if (!$terms.is(':checked')) {
          errors.push({
            message: 'You must accept our terms and conditions!',
            $focus: $terms,
            focusId: 'accept_agbs',
            inlineId: 'accept_agbs_error'
          });
          showInlineError($terms, 'You must accept our terms and conditions!', 'accept_agbs_error');
        }

        if (errors.length > 0) {
          // Build error summary
          var $list = $('#errorList');
          errors.forEach(function (err) {
            addErrorSummaryItem($list, err.$focus, err.focusId, err.message);
          });

          // Show and focus error summary (focus management requirement)
          $('#errorSummary').removeClass('hidden').focus();
          return false;
        }

        // LAB7 Q3: Show success message only when there are no errors (no alert)
        $('#successMessage').removeClass('hidden').focus();
        return true;
      }

      $(document).ready(function () {
        // LAB7 Q3: Validate only when "validate" param exists (keeps starter behavior)
        if ($.urlParam('validate')) {
          validateForm();
        }

        // Also validate on submit (better UX)
        $('form').on('submit', function (e) {
          e.preventDefault();
          validateForm();
        });
      });

    }).call(void 0);
  </script>
</body>
</html>
